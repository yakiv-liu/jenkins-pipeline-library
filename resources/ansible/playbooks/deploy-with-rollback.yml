---
- name: éƒ¨ç½²åº”ç”¨ï¼ˆç®€åŒ–ç‰ˆï¼Œæ— å†…ç½®å›æ»šï¼Œä¾èµ– Jenkins è‡ªåŠ¨å›æ»šï¼‰
  hosts: all
  vars:
    app_name: "{{ project_name }}"
    target_host: "{{ ansible_host }}"
    # å¥åº·æ£€æŸ¥é…ç½®
    health_check_max_retries: 12
    health_check_retry_delay: 5

  tasks:
    - name: åˆ›å»ºåº”ç”¨ç›®å½•
      file:
        path: "{{ app_dir }}"
        state: directory
        mode: '0755'

    - name: æ‹‰å–æ–°ç‰ˆæœ¬é•œåƒ
      shell: |
        echo "å¼€å§‹æ‹‰å–é•œåƒ: {{ harbor_url }}/{{ app_name }}:{{ app_version }}"
        docker pull "{{ harbor_url }}/{{ app_name }}:{{ app_version }}"
        echo "é•œåƒæ‹‰å–å®Œæˆ"
      args:
        executable: '/bin/bash'

    - name: éƒ¨ç½²æ–°ç‰ˆæœ¬
      block:
        - name: åœæ­¢å½“å‰å®¹å™¨
          docker_container:
            name: "{{ app_name }}"
            state: absent
          ignore_errors: yes

        - name: å¯åŠ¨æ–°å®¹å™¨
          docker_container:
            name: "{{ app_name }}"
            image: "{{ harbor_url }}/{{ app_name }}:{{ app_version }}"
            state: started
            restart_policy: always
            ports:
              - "{{ app_port }}:{{ app_port }}"
            env:
              SPRING_PROFILES_ACTIVE: "{{ deploy_env }}"
              JAVA_OPTS: "-Xmx512m -Xms256m -Dapp.version={{ app_version }} -Dapp.env={{ deploy_env }}"
              APP_VERSION: "{{ app_version }}"
              GIT_COMMIT: "{{ git_commit | default('unknown') }}"
            memory: 512m
            cpus: 0.5

        - name: ç­‰å¾…åº”ç”¨ç¨‹åºå¯åŠ¨
          wait_for:
            delay: 10

        - name: æ‰§è¡Œå®Œæ•´å¥åº·æ£€æŸ¥
          shell: |
            echo "å¼€å§‹å¥åº·æ£€æŸ¥ï¼Œæœ€å¤šå°è¯• {{ health_check_max_retries }} æ¬¡ï¼Œæ¯æ¬¡é—´éš” {{ health_check_retry_delay }} ç§’"

            for i in $(seq 1 {{ health_check_max_retries }}); do
              echo "å¥åº·æ£€æŸ¥å°è¯• $i/{{ health_check_max_retries }}"

              # åŸºç¡€è¿é€šæ€§æ£€æŸ¥
              if curl -f -s -o /dev/null -w "HTTPçŠ¶æ€: %{http_code}\n" "http://localhost:{{ app_port }}/health"; then
                echo "âœ… åŸºç¡€å¥åº·æ£€æŸ¥é€šè¿‡"

                # åº”ç”¨ä¸šåŠ¡æ£€æŸ¥ï¼ˆå¦‚æœåº”ç”¨æœ‰ä¸šåŠ¡ç«¯ç‚¹ï¼‰
                if curl -f -s -o /dev/null -w "ä¸šåŠ¡çŠ¶æ€: %{http_code}\n" "http://localhost:{{ app_port }}/hello"; then
                  echo "âœ… ä¸šåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡"
                  echo "ğŸ‰ æ‰€æœ‰å¥åº·æ£€æŸ¥é€šè¿‡ï¼"
                  exit 0
                else
                  echo "âš ï¸ ä¸šåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œä½†åŸºç¡€å¥åº·æ£€æŸ¥é€šè¿‡"
                fi
              else
                echo "âŒ åŸºç¡€å¥åº·æ£€æŸ¥å¤±è´¥"
              fi

              # å¦‚æœä¸æ˜¯æœ€åä¸€æ¬¡å°è¯•ï¼Œç­‰å¾…åç»§ç»­
              if [ $i -lt {{ health_check_max_retries }} ]; then
                echo "ç­‰å¾… {{ health_check_retry_delay }} ç§’åé‡è¯•..."
                sleep {{ health_check_retry_delay }}
              fi
            done

            echo "ğŸ’¥ å¥åº·æ£€æŸ¥æœ€ç»ˆå¤±è´¥"
            exit 1
          register: health_check_result
          failed_when: health_check_result.rc != 0

        - name: è®°å½•éƒ¨ç½²æˆåŠŸ
          debug:
            msg: "éƒ¨ç½²æˆåŠŸï¼åº”ç”¨ç¨‹åºå·²é€šè¿‡æ‰€æœ‰å¥åº·æ£€æŸ¥"

      # === ä¿®æ”¹ç‚¹ï¼šç®€åŒ– rescue å—ï¼Œåªè®°å½•è¯Šæ–­ä¿¡æ¯ï¼Œä¸æ‰§è¡Œå›æ»š ===
      rescue:
        - name: éƒ¨ç½²å¤±è´¥ - è®°å½•è¯Šæ–­ä¿¡æ¯
          debug:
            msg: "éƒ¨ç½²å¤±è´¥ï¼Œå°†ç”± Jenkins è§¦å‘è‡ªåŠ¨å›æ»š..."

        - name: æ”¶é›†å®¹å™¨è¯Šæ–­ä¿¡æ¯
          block:
            - name: æ£€æŸ¥æœ€ç»ˆå®¹å™¨çŠ¶æ€
              shell: |
                echo "æ£€æŸ¥å®¹å™¨çŠ¶æ€..."
                docker ps -a --filter "name={{ app_name }}" || echo "å®¹å™¨ä¸å­˜åœ¨"
              register: final_container_status
              failed_when: false

            - name: æ˜¾ç¤ºæœ€ç»ˆå®¹å™¨çŠ¶æ€
              debug:
                var: final_container_status.stdout

            - name: è·å–å®¹å™¨æ—¥å¿—
              shell: |
                echo "è·å–å®¹å™¨æ—¥å¿—..."
                docker logs "{{ app_name }}" --tail 100 || echo "æ— æ³•è·å–æ—¥å¿—"
              register: final_container_logs
              failed_when: false

            - name: æ˜¾ç¤ºå®¹å™¨æ—¥å¿—
              debug:
                var: final_container_logs.stdout

            - name: æ£€æŸ¥ç³»ç»Ÿèµ„æº
              shell: |
                echo "æ£€æŸ¥ç³»ç»Ÿèµ„æº..."
                echo "å†…å­˜ä½¿ç”¨:"
                free -h || echo "æ— æ³•è·å–å†…å­˜ä¿¡æ¯"
                echo "ç£ç›˜ä½¿ç”¨:"
                df -h || echo "æ— æ³•è·å–ç£ç›˜ä¿¡æ¯"
                echo "å½“å‰è¿è¡Œçš„å®¹å™¨:"
                docker ps || echo "æ— æ³•è·å–å®¹å™¨åˆ—è¡¨"
              register: system_info
              failed_when: false

            - name: æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
              debug:
                var: system_info.stdout

          rescue:
            - name: è¯Šæ–­ä¿¡æ¯æ”¶é›†å¤±è´¥
              debug:
                msg: "æ— æ³•æ”¶é›†å®Œæ•´çš„è¯Šæ–­ä¿¡æ¯"

        - name: æ¸…ç†å¤±è´¥å®¹å™¨
          docker_container:
            name: "{{ app_name }}"
            state: absent
          ignore_errors: yes

        - name: è®°å½•éƒ¨ç½²å¤±è´¥ä¿¡æ¯
          debug:
            msg: "éƒ¨ç½²å¤±è´¥ä¿¡æ¯å·²è®°å½•ï¼ŒJenkins å°†è§¦å‘è‡ªåŠ¨å›æ»š"

        - name: æŠ›å‡ºéƒ¨ç½²å¤±è´¥å¼‚å¸¸
          fail:
            msg: "éƒ¨ç½²å¤±è´¥ï¼Œå°†ç”± Jenkins è§¦å‘è‡ªåŠ¨å›æ»šã€‚å¥åº·æ£€æŸ¥çŠ¶æ€: {{ health_check_result.rc }}"